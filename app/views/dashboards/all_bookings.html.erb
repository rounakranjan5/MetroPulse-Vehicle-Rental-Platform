<div class="container my-5">
  <h1 class="mb-4"><%=t('bookings.all_bookings')%></h1>

<div class="card mb-4  border-0">
        <div class="card-body">
            <%= form_with url: all_bookings_path, method: :get, class: "row g-3", data: { turbo: false } do |f| %>

            <% if params[:filter].present? %>
              <%= hidden_field_tag :filter, params[:filter] %>
            <% end %>

            <div class="col-md-4">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <%= f.text_field :search, value: params[:search], class: "form-control", placeholder: t('bookings.search_placeholder') %>
              </div>
            </div>

            <div class="col-md-3">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                <%= f.date_field :booking_date, value: params[:booking_date], class: "form-control", placeholder: "Filter by date" %>
              </div>
            </div>

            <div class="col-md-2">
              <%= f.number_field :min_price, value: params[:min_price], class: "form-control", placeholder: t('bookings.min_price') %>
            </div>
            <div class="col-md-2">
              <%= f.number_field :max_price, value: params[:max_price], class: "form-control", placeholder: t('bookings.max_price') %>
            </div>

            <div class="col-md-1">
              <div class="d-grid">
                <%= f.submit t('common.search'), class: "btn btn-dark" %>
              </div>
            </div>
            <% end %>
        </div>
    </div>

    <% if params[:search].present? || params[:booking_date].present? || params[:min_price].present? || params[:max_price].present? %>
  <div class="alert alert-info mb-4">
    <div class="d-flex justify-content-between align-items-center">
 <div>

        Showing <%= @filtered_bookings.count %> search results
        <% if params[:search].present? %>
          for "<%= params[:search] %>"
        <% end %>
        <% if params[:booking_date].present? %>
          on <%= Date.parse(params[:booking_date]).strftime("%B %d, %Y") %>
        <% end %>
        <% if params[:min_price].present? && params[:max_price].present? %>
        with price range in between ₹<%= params[:min_price] %> and ₹<%= params[:max_price] %>
        <% elsif params[:min_price].present? %>
          with min price ₹<%= params[:min_price] %>
        <% elsif params[:max_price].present? %>
          with max price ₹<%= params[:max_price] %>
        <% end %>
      </div> 
      <%= link_to "Clear Search", all_bookings_path(filter: params[:filter]), class: "btn btn-sm btn-outline-primary" %>
    </div>
  </div>
<% end %>


  
  <div class="mb-4 d-flex gap-3 justify-content-center">
    <%= link_to all_bookings_path(filter: "pending"), 
                class: "btn btn-outline-warning position-relative #{params[:filter] == 'pending' || params[:filter].blank? ? 'active' : ''}" do %>
      Pending
      <% pending_count = Current.user.role == 'Provider' ? 
                        Booking.where(provider_id: Current.user.id, status: "pending").count : 
                        Booking.where(customer_id: Current.user.id, status: "pending").count %>
      
      <% if pending_count > 0 %>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="margin-left: -5px;">
          <%= pending_count %>
        </span>
      <% end %>
    <% end %>
    
    <%= link_to all_bookings_path(filter: "accepted"), 
                class: "btn btn-outline-primary position-relative #{params[:filter] == 'accepted' ? 'active' : ''}" do %>
      Accepted
      <% accepted_count = Current.user.role == 'Provider' ? 
                          Booking.where(provider_id: Current.user.id, status: "accepted").count : 
                          Booking.where(customer_id: Current.user.id, status: "accepted").count %>
      <% if accepted_count > 0 %>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary" style="margin-left: -5px;">
          <%= accepted_count %>
        </span>   
      <% end %>
    <% end %>

    <%= link_to "Completed", all_bookings_path(filter: "completed"), 
                class: "btn btn-outline-success #{params[:filter] == 'completed' ? 'active' : ''}" %>
    <%= link_to "Canceled", all_bookings_path(filter: "canceled"), 
                class: "btn btn-outline-danger #{params[:filter] == 'canceled' ? 'active' : ''}" %>
  </div>

  <% bookings = 
     case params[:filter]
     when "completed"
       @bookings.completed
     when "accepted"
       @bookings.accepted
     when "canceled"
       @bookings.canceled
     else
       @bookings.pending
     end
  %>

  <% if bookings.any? %>
    <div class="d-flex justify-content-end mb-3">
  <div class="btn-group">
    <button type="button" class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
      Sort by
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li><%= link_to "Newest First", request.params.merge(sort: "date_desc"), class: "dropdown-item" %></li>
      <li><%= link_to "Oldest First", request.params.merge(sort: "date_asc"), class: "dropdown-item" %></li>
      <li><%= link_to "Price: High to Low", request.params.merge(sort: "price_desc"), class: "dropdown-item" %></li>
      <li><%= link_to "Price: Low to High", request.params.merge(sort: "price_asc"), class: "dropdown-item" %></li>
    </ul>
  </div>
</div>
    <table class="table table-striped">
      <thead>
        <tr>
          <th><%=t('bookings.vehicle_image')%></th>
          <th><%=t('bookings.vehicle')%></th>
          <th><%=t('bookings.station')%></th>
          <th><%=t('bookings.city')%></th>
          <th><%=t('bookings.status')%></th>
          <th><%=t('bookings.booking_date')%></th>
          <th><%=t('bookings.duration')%></th>
          <th><%=t('bookings.price')%></th>
          <th><%=t('bookings.actions')%></th>
        </tr>
      </thead>
      <tbody>
        <% @filtered_bookings.each do |booking| %>
          <tr>
            <td>
              <% if booking.vehicle&.image_url.present? %>
                <img src="<%= booking.vehicle.image_url %>" alt="<%= booking.vehicle_type %>" class="img-thumbnail" style="width: 80px; height: 60px; object-fit: cover;">
              <% else %>
                <img src="https://via.placeholder.com/80x60?text=No+Image" alt="No image" class="img-thumbnail">
              <% end %>
            </td>
            <td><%= booking.vehicle_type %></td>
            <td><%= booking.rental_station.name %></td>
            <td><%= booking.rental_station.city || "N/A" %></td>
            <td>
              <% if booking.status == "pending" %>
                <span class="badge bg-warning text-dark">Pending</span>
              <% elsif booking.status == "accepted" %>
                <span class="badge bg-primary">Accepted</span>
              <% elsif booking.status == "completed" %>
                <span class="badge bg-success">Completed</span>
              <% elsif booking.status == "canceled" %>
                <span class="badge bg-danger">Canceled</span>
              <% end %>
            </td>
            <td>
  <% if booking.booking_date %>
    <%= booking.booking_date.to_time.in_time_zone('Asia/Kolkata').strftime("%d %b %Y %I:%M %p") %>
  <% end %>
</td>

            <td><%= booking.duration %> hour(s)</td>
            <td>₹<%= booking.price %></td>
            <td>
              <% if booking.status == "pending" && booking.provider_id == Current.user.id %>
                <div class="d-flex gap-2">
                <%= button_to "Accept", accept_booking_path(booking), method: :post, class: "btn btn-primary btn-sm" %>
                 <%= button_to "Cancel", cancel_booking_path(booking), method: :post, 
                              class: "btn btn-danger btn-sm" %>
                </div>
              <% elsif booking.status == "accepted" && booking.customer_id == Current.user.id %>
                <%= button_to "Complete Ride", complete_booking_path(booking), method: :post, class: "btn btn-success btn-sm" %>
              <% elsif booking.status == "pending" %>
                <%= button_to "Cancel", cancel_booking_path(booking), method: :post, 
                              class: "btn btn-danger btn-sm" %>

              <%elsif booking.status=='completed' %>
              <% if Current.user.role=='Customer' %>
<% if !booking.reviewed? %>
  <%= link_to "Review", review_booking_path(booking), class: "btn btn-warning btn-sm" %>
<% elsif booking.reviewed? %>
  <span class="badge bg-success">Reviewed</span>
<% end %>                
<%end%>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-muted"><%=t('bookings.nobookingsmsg')%></p>
  <% end %>
</div>

<% if @filtered_bookings.any? %>
<div class="custom-pagination pagination d-flex justify-content-center my-4">
  <%= will_paginate @filtered_bookings %>
</div>
<% end %>


<style>
.custom-pagination .pagination {
  display: flex;
  list-style: none;
  padding-left: 0;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

.custom-pagination .pagination a,
.custom-pagination .pagination span {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 0.9rem;
  border-radius: 999px; 
  border: 1px solid #dee2e6;
  background-color: #fff;
  color: #0d6efd;
  text-decoration: none;
  font-weight: 500;
  min-width: 42px;
  height: 42px;
  line-height: 1;
  transition: all 0.3s ease;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.custom-pagination .pagination a:hover:not(.disabled):not(.current) {
  background-color: #0d6efd;
  color: #fff;
  border-color: #0d6efd;
}

.custom-pagination .pagination .current {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 0.9rem;
  border-radius: 999px;
  background-color: #0d6efd;
  color: #fff;
  border: 1px solid #0d6efd;
  min-width: 42px;
  height: 42px;
  line-height: 1;
  font-weight: 500;
  pointer-events: none;
}

.custom-pagination .pagination .disabled {
  background-color: #f8f9fa;
  color: #adb5bd;
  border-color: #dee2e6;
  pointer-events: none;
  cursor: not-allowed;
}
</style>

